#!/bin/zsh

[ "$EUID" -eq 0 ] && { echo '\033[031mCannot run as root\033[0m'; exit 69 }

#####################################################################

DEPENDENCIES=(jq fzf wget mcrcon java)

for DEP in $DEPENDENCIES
do
	LINK=''
	case $DEP in
		jq     ) LINK='(https://github.com/stedolan/jq)' ;;
		fzf    ) LINK='(https://github.com/junegunn/fzf)' ;;
		wget   ) LINK='(https://gnu.org/software/wget)' ;;
		mcrcon ) LINK='(https://github.com/Tiiffi/mcrcon)' ;;
		java   ) LINK='(https://openjdk.java.net)' ;;
	esac

	command -v $DEP >/dev/null 2>&1 || {
		printf "\033[031m%s required %s\033[0m\n" "$DEP" "$LINK" >&2
		((MISSING_DEPENDENCIES+=1))
	}
done

[ $MISSING_DEPENDENCIES ] && exit $MISSING_DEPENDENCIES

#####################################################################

JAVA=$(which java)

FZF_OPTIONS=(--height 10 --layout=reverse --tac)

VERSION_MANIFEST_URL='https://launchermeta.mojang.com/mc/game/version_manifest.json'

MANAGER_PATH="$(pwd)"
VERSIONS_PATH="$MANAGER_PATH/versions"
SERVER_PATH="$MANAGER_PATH/server"
UNIVERSE_PATH="$MANAGER_PATH/worlds"
MOD_PATH="$MANAGER_PATH/mods"

WORLD="active"

SERVER_JAR="$SERVER_PATH/server.jar"
SERVER_PORT='25565'
SERVER_INITIAL_MEMORY_SIZE='512M'
SERVER_MAXIMUM_MEMORY_SIZE='2G'

MCRCON_PASS=''
MCRCON_HOST='127.0.0.1'
MCRCON_PORT='25575'

#####################################################################

[ ! "$LOCAL_OVERRIDE" ] && LOCAL_OVERRIDE="$HOME/.config/gizmos/minecraft-server-manager.conf"
[ -f "$LOCAL_OVERRIDE" ] && source "$LOCAL_OVERRIDE"

#####################################################################

[ ! -d "$VERSIONS_PATH" ] && mkdir "$VERSIONS_PATH";
[ ! -d "$SERVER_PATH" ] && mkdir "$SERVER_PATH"
[ ! -d "$UNIVERSE_PATH" ] && mkdir "$UNIVERSE_PATH";

export MCRCON_HOST MCRCON_PASS MCRCON_PORT
